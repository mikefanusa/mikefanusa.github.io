<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5XVDBXH4');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>TrueDraw å…¬å¹³æŠ½ | å¯†ç¢¼å­¸ç­‰ç´šäº‚æ•¸ç·šä¸ŠæŠ½çç¨‹å¼ (å°¾ç‰™/æ´»å‹•å°ˆç”¨)</title>
    <meta name="description"
        content="TrueDraw å…¬å¹³æŠ½æ˜¯ä¸€æ¬¾åŸºæ–¼ Web Crypto API çš„åŠ å¯†ç´šäº‚æ•¸æŠ½çç¨‹å¼ã€‚ä¿éšœçµ•å°å…¬å¹³ï¼Œç„¡å¾Œé–€ã€ä¸é‡è¤‡ä¸­çã€‚æ”¯æ´åå–®åŒ¯å…¥èˆ‡ CSV çµæœåŒ¯å‡ºï¼Œæ˜¯å…¬å¸å°¾ç‰™ã€ç¤¾ç¾¤æ´»å‹•çš„æœ€ä½³å…è²»æŠ½çå·¥å…·ã€‚">
    <meta name="keywords"
        content="æŠ½çç¨‹å¼, ç·šä¸ŠæŠ½ç, å°¾ç‰™æŠ½ç, äº‚æ•¸ç”¢ç”Ÿå™¨, TrueDraw, å…¬å¹³æŠ½, å¯†ç¢¼å­¸ç­‰ç´šäº‚æ•¸, CSPRNG, Web Crypto API, ä¸é‡è¤‡æŠ½ç, å…è²»æŠ½çå·¥å…·">
    <meta name="author" content="TrueDraw Team">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TrueDraw å…¬å¹³æŠ½ | æœ€å®‰å…¨çš„ç·šä¸ŠæŠ½çå·¥å…·">
    <meta property="og:description" content="æ‹’çµ•å½éš¨æ©Ÿï¼ä½¿ç”¨éŠ€è¡ŒåŠ å¯†ç­‰ç´šæ¼”ç®—æ³• (CSPRNG) çš„æŠ½çç¨‹å¼ã€‚ä¿éšœæ´»å‹•å…¬å¹³æ€§ï¼Œç«‹å³å…è²»ä½¿ç”¨ã€‚">
    <meta property="og:url" content="https://mikefanusa.github.io/">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "TrueDraw å…¬å¹³æŠ½",
      "applicationCategory": "UtilityApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "TWD"
      },
      "description": "TrueDraw æ˜¯ä¸€å€‹åŸºæ–¼ç€è¦½å™¨ç«¯çš„å®‰å…¨æŠ½çç¨‹å¼ï¼Œä½¿ç”¨ Cryptographically Secure Pseudo-Random Number Generator (CSPRNG) æŠ€è¡“ï¼Œç¢ºä¿æŠ½ççµæœçš„éš¨æ©Ÿæ€§èˆ‡ä¸å¯é æ¸¬æ€§ã€‚",
      "featureList": "åŠ å¯†ç´šäº‚æ•¸, åå–®æ‰¹æ¬¡åŒ¯å…¥, çµæœCSVåŒ¯å‡º, æœ¬åœ°è³‡æ–™ä¿å­˜"
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©å‹•ç•« */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        /* æ»¾å‹•ç‰¹æ•ˆæ¨£å¼ */
        .rolling-text {
            transition: all 0.1s;
        }

        /* Modal å‹•ç•« */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans text-gray-800 flex flex-col">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5XVDBXH4" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="text-3xl">ğŸ²</div>
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">TrueDraw <span
                            class="text-blue-200 font-normal">å…¬å¹³æŠ½</span></h1>
                    <p class="text-xs text-blue-200 opacity-80">åŠ å¯†ç´šäº‚æ•¸ â€¢ çµ•å°å…¬å¹³</p>
                </div>
            </div>
            <div class="space-x-2">
                <button onclick="app.exportCSV()"
                    class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded shadow transition text-sm font-medium flex items-center inline-flex">
                    <span class="mr-1">ğŸ“¥</span> åŒ¯å‡ºçµæœ
                </button>
                <button onclick="app.resetData()"
                    class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded shadow transition text-sm font-medium flex items-center inline-flex">
                    <span class="mr-1">ğŸ—‘ï¸</span> é‡ç½®
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow flex flex-col gap-8">
        <!-- App Interface -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[600px]">

            <!-- Left Column: Settings -->

            <div class="bg-white p-4 rounded-lg shadow flex flex-col h-full">

                <div class="flex justify-between items-center mb-2">

                    <h2 class="text-xl font-semibold flex items-center">

                        <span class="bg-blue-100 text-blue-600 py-1 px-2 rounded text-sm mr-2">1</span>

                        çé …è¨­å®š

                    </h2>

                    <button id="editPrizesBtn" onclick="app.toggleEditMode('prizes')"
                        class="text-xs text-blue-500 hover:text-blue-700 underline hidden">ä¿®æ”¹</button>

                </div>



                <!-- Input Mode -->

                <textarea id="prizesInput"
                    class="w-full flex-grow p-3 border rounded focus:ring-2 focus:ring-blue-400 focus:outline-none resize-none font-mono text-sm"
                    placeholder="ç‰¹ç, 1&#10;äºŒç, 3&#10;ä¸‰ç, 5"></textarea>



                <!-- List Mode (Visual) -->

                <div id="prizesListView"
                    class="w-full flex-grow border rounded overflow-y-auto hidden bg-gray-50 p-2 space-y-1">

                    <!-- Dynamic Items -->

                </div>

            </div>



            <!-- Center Column: Action -->

            <div class="bg-white p-4 rounded-lg shadow flex flex-col h-full relative">

                <div class="flex justify-between items-center mb-2">

                    <h2 class="text-xl font-semibold flex items-center">

                        <span class="bg-blue-100 text-blue-600 py-1 px-2 rounded text-sm mr-2">2</span>

                        åƒèˆ‡è€…åå–®

                    </h2>

                    <button id="editNamesBtn" onclick="app.toggleEditMode('names')"
                        class="text-xs text-blue-500 hover:text-blue-700 underline hidden">ä¿®æ”¹</button>

                </div>



                <!-- Input Mode -->

                <textarea id="namesInput"
                    class="w-full h-1/2 p-3 border rounded focus:ring-2 focus:ring-blue-400 focus:outline-none resize-none font-mono text-sm mb-4"
                    placeholder="ç‹å°æ˜&#10;æå¤§è¯&#10;å¼µä¸‰"></textarea>



                <!-- List Mode (Visual) -->

                <div id="namesListView"
                    class="w-full h-1/2 border rounded overflow-y-auto hidden bg-gray-50 p-2 space-y-1 mb-4 text-sm">

                    <!-- Dynamic Items -->

                </div>



                <!-- Display Area -->

                <div
                    class="flex-grow flex flex-col items-center justify-center bg-gray-50 rounded border-2 border-dashed border-gray-300 p-4 relative overflow-hidden">

                    <div id="currentDrawDisplay" class="text-4xl font-bold text-gray-700 text-center z-10 break-all">

                        æº–å‚™å°±ç·’

                    </div>

                    <div id="currentPrizeDisplay" class="text-lg text-blue-500 mt-2 font-medium z-10">

                        <!-- ç•¶å‰æŠ½å–çš„çé … -->

                    </div>

                </div>



                <!-- Action Button -->

                <button id="drawBtn" onclick="app.startDraw()"
                    class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 rounded-lg shadow-lg transform active:scale-95 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed">

                    é–‹å§‹æŠ½ç

                </button>

            </div>

            <!-- Right Column: Results -->
            <div class="bg-white p-4 rounded-lg shadow flex flex-col h-full">
                <h2 class="text-xl font-semibold mb-2 flex items-center">
                    <span class="bg-blue-100 text-blue-600 py-1 px-2 rounded text-sm mr-2">3</span>
                    ä¸­ççµæœ
                </h2>
                <div class="flex-grow overflow-y-auto pr-2" id="resultsList">
                    <!-- Results will be injected here -->
                    <div class="text-center text-gray-400 mt-10">å°šç„¡ä¸­çç´€éŒ„</div>
                </div>
                <div class="mt-2 text-right text-sm text-gray-500">
                    å·²æŠ½å‡º <span id="drawnCount">0</span> ä½ / å‰©é¤˜ <span id="remainingCount">0</span> ä½
                </div>
            </div>
        </div>

        <!-- SEO Content Section: About TrueDraw -->
        <section class="bg-white rounded-lg shadow p-8 mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">é—œæ–¼ TrueDraw å…¬å¹³æŠ½</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-gray-700">
                <div>
                    <h3 class="font-bold text-lg text-indigo-700 mb-2">ğŸ›¡ï¸ ç‚ºä»€éº¼ TrueDraw æ˜¯æœ€å®‰å…¨çš„é¸æ“‡ï¼Ÿ</h3>
                    <p class="mb-4 text-sm leading-relaxed">
                        ä¸€èˆ¬çš„ç¶²é æŠ½çé€šå¸¸ä½¿ç”¨ <code>Math.random()</code>ï¼Œé€™æ˜¯ä¸€ç¨®ã€Œå½éš¨æ©Ÿã€ç®—æ³•ï¼Œç†è«–ä¸Šå¯è¢«é æ¸¬ã€‚
                        <strong>TrueDraw å…¬å¹³æŠ½</strong> æ¡ç”¨ç€è¦½å™¨åŸç”Ÿçš„ <strong>Web Crypto API</strong>ï¼Œ
                        é€™èˆ‡éŠ€è¡ŒåŠ å¯†å‚³è¼¸ä½¿ç”¨ç›¸åŒçš„æŠ€è¡“æ ¸å¿ƒ (CSPRNG)ï¼Œèƒ½ç”¢ç”ŸçœŸæ­£çš„åŠ å¯†ç´šäº‚æ•¸ï¼Œç¢ºä¿æ¯ä¸€æ¬¡æŠ½çéƒ½ç„¡æ³•è¢«æ“æ§æˆ–é æ¸¬ã€‚
                    </p>
                    <h3 class="font-bold text-lg text-indigo-700 mb-2">ğŸš€ å®Œå…¨å…è²»ã€éš±ç§å„ªå…ˆ</h3>
                    <p class="mb-4 text-sm leading-relaxed">
                        TrueDraw æ˜¯ä¸€å€‹ç´”å‰ç«¯é‹ä½œçš„ Web Appã€‚æ‚¨çš„åƒèˆ‡è€…åå–®åªæœƒä¿å­˜åœ¨æ‚¨çš„ç€è¦½å™¨æš«å­˜ (LocalStorage) ä¸­ï¼Œ
                        <strong>æ°¸é ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</strong>ã€‚é€™æ„å‘³è‘—æ‚¨å¯ä»¥å®‰å¿ƒè™•ç†å…¬å¸å…§éƒ¨çš„æ•æ„Ÿåå–®ï¼Œç„¡éœ€æ“”å¿ƒè³‡æ–™å¤–æ´©ã€‚
                    </p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-indigo-700 mb-2">ğŸ“‹ å¸¸è¦‹å•é¡Œ (FAQ)</h3>
                    <ul class="space-y-3 text-sm">
                        <li>
                            <span class="font-bold text-gray-900">Q: æœƒé‡è¤‡ä¸­çå—ï¼Ÿ</span><br>
                            A: ä¸æœƒã€‚ç³»çµ±æœƒè‡ªå‹•è¿½è¹¤å·²ä¸­çåå–®ï¼Œä¸€æ—¦è¢«æŠ½å‡ºå°±æœƒå¾ç•¶æ¬¡çš„åå–®æ± ä¸­æš«æ™‚ç§»é™¤ï¼Œç›´åˆ°æ‚¨é‡ç½®è³‡æ–™ã€‚
                        </li>
                        <li>
                            <span class="font-bold text-gray-900">Q: ç¶²é é—œæ‰è³‡æ–™æœƒä¸è¦‹å—ï¼Ÿ</span><br>
                            A: ä¸æœƒã€‚TrueDraw å…·å‚™è‡ªå‹•ä¿å­˜åŠŸèƒ½ï¼Œå¦‚æœä¸å°å¿ƒé—œé–‰è¦–çª—ï¼Œé‡æ–°æ‰“é–‹å¾Œï¼Œå‰›æ‰çš„è¨­å®šèˆ‡ä¸­ççµæœéƒ½æœƒè‡ªå‹•æ¢å¾©ã€‚
                        </li>
                        <li>
                            <span class="font-bold text-gray-900">Q: å¦‚ä½•åŒ¯å‡ºçµæœï¼Ÿ</span><br>
                            A: é»æ“Šå³ä¸Šè§’çš„ã€ŒåŒ¯å‡ºçµæœã€æŒ‰éˆ•ï¼Œå³å¯å°‡ç›®å‰çš„ä¸­çåå–®ä¸‹è¼‰ç‚º Excel å¯è®€å–çš„ CSV æª”æ¡ˆã€‚
                        </li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 text-center text-sm mt-auto">
        <p>&copy; 2026 TrueDraw å…¬å¹³æŠ½. All rights reserved. | Designed for Fairness & Security.</p>
    </footer>

    <!-- Modal -->
    <div id="winnerModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-lg p-8 max-w-md w-full text-center shadow-2xl transform scale-90 transition-transform duration-300"
            id="modalContent">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">æ­å–œç²çï¼</h3>
            <p class="text-lg text-gray-600 mb-6">
                <span id="modalWinner" class="text-3xl font-bold text-indigo-600 block my-2"></span>
                ç²å¾—
                <span id="modalPrize" class="text-xl font-bold text-orange-500 block mt-1"></span>
            </p>
            <button onclick="app.closeModal()"
                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition w-full">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        class LotteryApp {
            constructor() {
                // DOM Elements - Inputs
                this.prizesInput = document.getElementById('prizesInput');
                this.namesInput = document.getElementById('namesInput');

                // DOM Elements - List Views & Controls
                this.prizesListView = document.getElementById('prizesListView');
                this.namesListView = document.getElementById('namesListView');
                this.editPrizesBtn = document.getElementById('editPrizesBtn');
                this.editNamesBtn = document.getElementById('editNamesBtn');

                // DOM Elements - Status & Action
                this.resultsList = document.getElementById('resultsList');
                this.currentDrawDisplay = document.getElementById('currentDrawDisplay');
                this.currentPrizeDisplay = document.getElementById('currentPrizeDisplay');
                this.drawBtn = document.getElementById('drawBtn');
                this.drawnCountEl = document.getElementById('drawnCount');
                this.remainingCountEl = document.getElementById('remainingCount');

                // DOM Elements - Modal
                this.winnerModal = document.getElementById('winnerModal');
                this.modalContent = document.getElementById('modalContent');
                this.modalWinner = document.getElementById('modalWinner');
                this.modalPrize = document.getElementById('modalPrize');

                // State
                this.isRolling = false;
                this.isLocked = false;
                this.results = []; // Array of { prize: string, winner: string, timestamp: number }

                this.init();
            }

            init() {
                this.loadData();

                // Auto-save listeners
                this.prizesInput.addEventListener('input', () => this.saveData());
                this.namesInput.addEventListener('input', () => this.saveData());

                this.renderResults();
                this.updateStatus();

                // Restore locked state if draw in progress
                if (this.results.length > 0) {
                    this.setLockState(true);
                }

                this.addGlobalListeners();
            }

            addGlobalListeners() {
                window.addEventListener('keydown', (e) => {
                    if (['TEXTAREA', 'INPUT'].includes(document.activeElement.tagName)) return;

                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!this.winnerModal.classList.contains('hidden')) {
                            this.closeModal();
                        } else if (!this.isRolling && !this.drawBtn.disabled) {
                            this.startDraw();
                        }
                    }
                });
            }

            // ==========================================
            // ğŸ’¾ Data Persistence
            // ==========================================

            loadData() {
                const get = (k) => localStorage.getItem(k);
                const savedPrizes = get('lottery_prizes');
                const savedNames = get('lottery_names');
                const savedResults = get('lottery_results');

                if (savedPrizes) this.prizesInput.value = savedPrizes;
                if (savedNames) this.namesInput.value = savedNames;
                if (savedResults) this.results = JSON.parse(savedResults);
            }

            saveData() {
                localStorage.setItem('lottery_prizes', this.prizesInput.value);
                localStorage.setItem('lottery_names', this.namesInput.value);
                localStorage.setItem('lottery_results', JSON.stringify(this.results));
                this.updateStatus();
            }

            resetData() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡æœƒæ¸…ç©ºçé …ã€åå–®èˆ‡æ‰€æœ‰ä¸­çç´€éŒ„ã€‚')) {
                    this.prizesInput.value = '';
                    this.namesInput.value = '';
                    this.results = [];
                    this.saveData();
                    this.renderResults();
                    this.currentDrawDisplay.textContent = 'æº–å‚™å°±ç·’';
                    this.setLockState(false);
                    this.updateStatus();
                }
            }

            exportCSV() {
                if (this.results.length === 0) return alert('ç›®å‰æ²’æœ‰ä¸­çè³‡æ–™å¯åŒ¯å‡ºã€‚');

                let csvContent = "\uFEFFçé …,å¾—çè€…,æ™‚é–“\n";
                this.results.forEach(row => {
                    const date = new Date(row.timestamp).toLocaleString();
                    const prize = row.prize.replace(/"/g, '""');
                    const winner = row.winner.replace(/"/g, '""');
                    csvContent += `"${prize}","${winner}","${date}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "æŠ½ççµæœ.csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // ==========================================
            // ğŸ§  Core Logic
            // ==========================================

            getPrizePool() {
                const lines = this.prizesInput.value.split('\n').filter(line => line.trim() !== '');
                let pool = [];
                let error = null;

                lines.forEach((line, index) => {
                    const parts = line.split(',');
                    if (parts.length < 2) {
                        pool.push(line.trim());
                    } else {
                        const name = parts[0].trim();
                        const qty = parseInt(parts.slice(1).join('').trim(), 10);
                        if (isNaN(qty) || qty < 1) {
                            error = `ç¬¬ ${index + 1} è¡Œçé …æ•¸é‡æ ¼å¼éŒ¯èª¤: "${line}"`;
                        } else {
                            for (let i = 0; i < qty; i++) pool.push(name);
                        }
                    }
                });
                return { pool, error };
            }

            getParticipants() {
                return this.namesInput.value.split('\n').map(n => n.trim()).filter(n => n !== '');
            }

            // IMPORTANT: Method signature used by external scripts (Do not change)
            getEligibleParticipants() {
                const allParticipants = this.getParticipants();
                const winners = new Set(this.results.map(r => r.winner));
                return allParticipants.filter(p => !winners.has(p));
            }

            getSecureRandomInt(max) {
                try {
                    if (window.crypto && window.crypto.getRandomValues) {
                        const array = new Uint32Array(1);
                        window.crypto.getRandomValues(array);
                        return Math.floor((array[0] / (0xffffffff + 1)) * max);
                    }
                } catch (e) {
                    console.warn("Crypto API failed, fallback to Math.random", e);
                }
                return Math.floor(Math.random() * max);
            }

            // IMPORTANT: Method signature used by external scripts (Do not change)
            pickWinner(eligible, prizeName) {
                return eligible[this.getSecureRandomInt(eligible.length)];
            }

            // ==========================================
            // ğŸ¬ Draw Flow & Animation
            // ==========================================

            startDraw() {
                const validation = this.validateDrawCondition();
                if (validation.error) return alert(validation.error);

                // Start Flow
                this.setLockState(true);
                this.isRolling = true;
                this.drawBtn.disabled = true;

                // Run Animation -> Finalize
                this.runDrawAnimation(validation.eligible, validation.nextPrize);
            }

            validateDrawCondition() {
                const { pool, error } = this.getPrizePool();
                if (error) return { error };

                const nextPrizeIndex = this.results.length;
                if (nextPrizeIndex >= pool.length) return { error: 'æ‰€æœ‰çé …å·²ç¶“æŠ½å–å®Œç•¢ï¼' };

                const eligible = this.getEligibleParticipants();
                if (eligible.length === 0) return { error: 'æ²’æœ‰å‰©é¤˜çš„åƒèˆ‡è€…å¯ä¾›æŠ½çï¼' };

                return {
                    pool,
                    eligible,
                    nextPrize: pool[nextPrizeIndex]
                };
            }

            runDrawAnimation(eligible, nextPrize) {
                let duration = 2000;
                let startTime = null;

                const animate = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = timestamp - startTime;

                    // Random Name Effect
                    const randomName = eligible[this.getSecureRandomInt(eligible.length)];
                    this.currentDrawDisplay.textContent = randomName;
                    this.currentDrawDisplay.className = "text-5xl font-bold text-indigo-600 text-center z-10 break-all rolling-text";

                    if (progress < duration) {
                        requestAnimationFrame(animate);
                    } else {
                        this.finalizeDraw(eligible, nextPrize);
                    }
                };
                requestAnimationFrame(animate);
            }

            finalizeDraw(eligible, prizeName) {
                const winner = this.pickWinner(eligible, prizeName);

                this.results.push({
                    prize: prizeName,
                    winner: winner,
                    timestamp: new Date().toISOString()
                });

                this.saveData();

                // UI Cleanup
                this.isRolling = false;
                this.updateStatus();
                this.renderResults();
                this.showModal(winner, prizeName);
            }

            // ==========================================
            // ğŸ¨ UI & Rendering
            // ==========================================

            updateStatus() {
                const { pool } = this.getPrizePool();
                const eligible = this.getEligibleParticipants();

                this.renderListViews();

                const nextPrizeIndex = this.results.length;
                const nextPrize = pool[nextPrizeIndex];
                const isFinished = pool.length > 0 && this.results.length >= pool.length;

                // Update Text
                if (nextPrize) {
                    this.currentPrizeDisplay.textContent = `å³å°‡æŠ½å–ï¼š${nextPrize}`;
                    this.setDrawButtonState(true, 'é–‹å§‹æŠ½ç');
                } else {
                    this.currentPrizeDisplay.textContent = isFinished ? 'æ‰€æœ‰çé …å·²æŠ½å–å®Œç•¢' : 'è«‹å…ˆè¨­å®šçé …';
                    this.setDrawButtonState(false, 'æŠ½ççµæŸ');
                }

                if (this.isRolling) this.drawBtn.disabled = true;

                this.drawnCountEl.textContent = this.results.length;
                this.remainingCountEl.textContent = eligible.length;
            }

            setDrawButtonState(enabled, text) {
                this.drawBtn.textContent = text;
                this.drawBtn.disabled = !enabled;
                if (enabled) {
                    this.drawBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    this.drawBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                } else {
                    this.drawBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    this.drawBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                }
            }

            setLockState(locked) {
                this.isLocked = locked;
                const toggle = (el, show) => el.classList.toggle('hidden', !show);

                toggle(this.prizesInput, !locked);
                toggle(this.namesInput, !locked);
                toggle(this.prizesListView, locked);
                toggle(this.namesListView, locked);
                toggle(this.editPrizesBtn, locked);
                toggle(this.editNamesBtn, locked);

                this.renderListViews();
            }

            toggleEditMode(type) {
                if (this.results.length > 0 && !confirm("ä¿®æ”¹è¨­å®šå¯èƒ½å°è‡´æŠ½çé †åºæˆ–åå–®ä¸ä¸€è‡´ï¼Œç¢ºå®šè¦åˆ‡æ›å›ç·¨è¼¯æ¨¡å¼å—ï¼Ÿ")) return;
                this.setLockState(false);
            }

            renderListViews() {
                // Prizes List
                const { pool } = this.getPrizePool();
                const drawnCount = this.results.length;

                this.prizesListView.innerHTML = pool.length ? '' : '<div class="text-gray-400 text-xs italic p-2">è«‹å…ˆè¼¸å…¥çé …</div>';

                pool.forEach((prize, index) => {
                    const isDrawn = index < drawnCount;
                    const el = document.createElement('div');
                    el.className = `p-2 rounded text-sm flex items-center ${isDrawn ? 'bg-red-50 text-red-500' : 'bg-white text-gray-700'} border-b last:border-0`;
                    el.innerHTML = `
                        <span class="w-6 text-xs text-gray-400 mr-2">${index + 1}.</span>
                        <span class="${isDrawn ? 'line-through' : ''} font-medium">${prize}</span>
                        ${isDrawn ? '<span class="ml-auto text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">å·²æŠ½å‡º</span>' : ''}
                    `;
                    this.prizesListView.appendChild(el);
                });

                // Names List
                const participants = this.getParticipants();
                const winnersSet = new Set(this.results.map(r => r.winner));

                this.namesListView.innerHTML = participants.length ? '' : '<div class="text-gray-400 text-xs italic p-2">è«‹å…ˆè¼¸å…¥åå–®</div>';

                participants.forEach((name) => {
                    const isWinner = winnersSet.has(name);
                    const el = document.createElement('div');
                    el.className = `px-2 py-1.5 rounded text-sm flex items-center ${isWinner ? 'bg-red-50 text-red-500' : 'hover:bg-gray-100 text-gray-700'}`;
                    el.innerHTML = `
                        <span class="${isWinner ? 'line-through font-bold' : ''}">${name}</span>
                        ${isWinner ? '<span class="ml-auto text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">ä¸­ç</span>' : ''}
                    `;
                    this.namesListView.appendChild(el);
                });
            }

            renderResults() {
                this.resultsList.innerHTML = this.results.length ? '' : '<div class="text-center text-gray-400 mt-10">å°šç„¡ä¸­çç´€éŒ„</div>';

                [...this.results].reverse().forEach((result) => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 p-3 rounded border-l-4 border-indigo-500 mb-2 flex justify-between items-center animate-slide-in';
                    div.innerHTML = `
                        <div><span class="font-bold text-gray-800">${result.winner}</span></div>
                        <div class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded">${result.prize}</div>
                    `;
                    this.resultsList.appendChild(div);
                });
            }

            showModal(winner, prize) {
                this.modalWinner.textContent = winner;
                this.modalPrize.textContent = prize;
                this.winnerModal.classList.remove('hidden');
                setTimeout(() => {
                    this.winnerModal.classList.remove('opacity-0');
                    this.modalContent.classList.remove('scale-90', 'scale-100');
                    this.modalContent.classList.add('scale-100');
                }, 10);
            }

            closeModal() {
                this.winnerModal.classList.add('opacity-0');
                this.modalContent.classList.remove('scale-100');
                this.modalContent.classList.add('scale-90');
                setTimeout(() => {
                    this.winnerModal.classList.add('hidden');
                    this.currentDrawDisplay.className = "text-4xl font-bold text-gray-700 text-center z-10 break-all";
                }, 300);
            }
        }

        // Initialize App
        window.LotteryApp = LotteryApp;
        const app = new LotteryApp();
    </script>
    <script src="jquery-3.7.1.min.js"></script>
</body>

</html>
